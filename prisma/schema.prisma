generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model Company {
  id                  Int                  @id @default(autoincrement())
  companyName         String
  companyEmail        String?              @unique
  companyTin          String?              @unique
  companyAddress      String?
  hrId                Int?
  companyDescription  String?
  timezone            String               @default("UTC")
  workStartTime       String               @default("09:00")
  workEndTime         String               @default("17:00")
  workStartTime2      String               @default("17:00")
  workEndTime2        String               @default("23:59")
  lateThreshold       Int                  @default(15)
  checkInDeadline     Int                  @default(15)
  lateThreshold2      Int                  @default(15)
  checkInDeadline2    Int                  @default(15)
  hasLifetimeAccess   Boolean              @default(false)
  createdAt           DateTime             @default(now())
  activities          Activity[]
  attendances         Attendance[]
  hr                  Employee?            @relation("Company_hr", fields: [hrId], references: [id])
  locations           CompanyLocation[]
  departments         Department[]
  employees           Employee[]
  EmployeeBenefit     EmployeeBenefit[]
  invitations         Invitation[]
  leaveRequests       LeaveRequest[]
  payrolls            Payroll[]
  documents           Document[]
  subscription        Subscription?
  payments            Payment[]
  WorkdayDaysConfig   WorkdayDaysConfig[]
  notifications       Notification[]
  calendars           Calendar[]
  performanceSettings PerformanceSettings?
  reviewTemplates     ReviewTemplate[]
  reviewCycles        ReviewCycle[]
}

model CompanyLocation {
  id          Int          @id @default(autoincrement())
  companyId   Int
  name        String
  latitude    Float
  longitude   Float
  isActive    Boolean      @default(true)
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  attendances Attendance[]
  company     Company      @relation(fields: [companyId], references: [id])
}

model Employee {
  id                   Int            @id @default(autoincrement())
  employeeId           String?        @unique
  name                 String
  email                String         @unique
  phone                String?
  profilePic           String?
  password             String
  position             String?
  departmentId         Int?
  companyId            Int?
  location             String?
  status               EmployeeStatus @default(ACTIVE)
  avatar               String?
  role                 Role
  shiftType            Shift?         @default(MORNING_SHIFT)
  dateOfBirth          DateTime?
  deleted              Boolean        @default(false)
  address              String?
  emergencyContact     String?
  employmentType       EmploymentType @default(FULL_TIME)
  salary               Float?
  lastLogin            DateTime?
  resetPasswordToken   String?
  resetPasswordExpires DateTime?

  emailVerified            Boolean                  @default(false)
  emailVerificationToken   String?                  @unique
  emailVerificationExpires DateTime?
  sumBonuses               Float?                   @default(0)
  createdAt                DateTime                 @default(now())
  attendances              Attendance[]             @relation("EmployeeAttendance")
  hrForCompanies           Company[]                @relation("Company_hr")
  managedDepartments       Department[]             @relation("DepartmentManager")
  company                  Company?                 @relation(fields: [companyId], references: [id])
  department               Department?              @relation(fields: [departmentId], references: [id])
  EmployeeBenefit          EmployeeBenefit[]
  EmployeePayrollProfile   EmployeePayrollProfile?
  sentInvitations          Invitation[]
  approvedLeaveRequests    LeaveRequest[]           @relation("LeaveApprover")
  leaveRequests            LeaveRequest[]
  notifications            Notification[]
  payrolls                 Payroll[]
  finalizedPayrolls        Payroll[]                @relation("Payroll_finalizedByToEmployee")
  documents                Document[]
  uploadedDocuments        Document[]               @relation("DocumentUploader")
  userNotificationReads    UserNotificationRead[]
  calendars                Calendar[]
  employeeWorkDaysConfigs  EmployeeWorkDaysConfig[]
  reviewsAsSubject         Review[]                 @relation("ReviewSubject")
  reviewsAsManager         Review[]                 @relation("ReviewManager")
  reviewResponses          ReviewResponse[]
}

model Department {
  id         Int          @id @default(autoincrement())
  name       String
  managerId  Int?
  createdAt  DateTime     @default(now())
  companyId  Int
  company    Company      @relation(fields: [companyId], references: [id])
  manager    Employee?    @relation("DepartmentManager", fields: [managerId], references: [id])
  employees  Employee[]
  Invitation Invitation[]
}

model Attendance {
  id         Int              @id @default(autoincrement())
  employeeId Int
  companyId  Int
  locationId Int?
  date       DateTime
  timeIn     DateTime?
  timeOut    DateTime?
  status     AttendanceStatus
  createdAt  DateTime         @default(now())
  updatedAt  DateTime         @updatedAt
  company    Company          @relation(fields: [companyId], references: [id])
  employee   Employee         @relation("EmployeeAttendance", fields: [employeeId], references: [id])
  location   CompanyLocation? @relation(fields: [locationId], references: [id])

  @@unique([employeeId, date])
}

model LeaveRequest {
  id               Int         @id @default(autoincrement())
  employeeId       Int
  companyId        Int
  leaveType        LeaveType
  startDate        DateTime
  endDate          DateTime
  days             Int
  status           LeaveStatus @default(PENDING)
  hrApprovalStatus LeaveStatus @default(PENDING)
  hrRejectReason   String?
  approverId       Int?
  comments         String?
  attachmentUrls   Json?
  isApproved       Boolean?
  rejectReason     String?
  approvedAt       DateTime?
  createdAt        DateTime    @default(now())
  updatedAt        DateTime    @default(now())
  approver         Employee?   @relation("LeaveApprover", fields: [approverId], references: [id])
  company          Company     @relation(fields: [companyId], references: [id])
  employee         Employee    @relation(fields: [employeeId], references: [id])
}

model Calendar {
  id          String       @id @default(cuid())
  companyId   Int
  createdById Int
  type        CalendarType
  date        DateTime     @db.Date
  name        String // "Christmas", "Company Founding Day"
  isActive    Boolean      @default(true)
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  company   Company   @relation(fields: [companyId], references: [id])
  createdBy Employee? @relation(fields: [createdById], references: [id])

  @@index([companyId])
  @@index([date])
  @@index([companyId, date])
  @@index([type])
}

enum CalendarType {
  PUBLIC_HOLIDAY
  SCHOOL_HOLIDAY
  EVENT
}

model Payroll {
  id                  Int           @id @default(autoincrement())
  employeeId          Int
  companyId           Int
  periodStart         DateTime
  periodEnd           DateTime
  baseSalary          Float
  bonuses             Float?        @default(0)
  benefitsCost        Float?        @default(0)
  grossPay            Float?
  incomeTax           Float?        @default(0)
  socialSecurity      Float?        @default(0)
  attendancePenalties Float?        @default(0)
  totalDeductions     Float?        @default(0)
  netPay              Float
  status              PayrollStatus @default(DRAFT)
  finalizedAt         DateTime?
  finalizedBy         Int?
  processedDate       DateTime?
  paymentMethod       String?
  notes               String?
  hoursWorked         Float?        @default(0)
  createdAt           DateTime      @default(now())
  company             Company       @relation(fields: [companyId], references: [id])
  employee            Employee      @relation(fields: [employeeId], references: [id])
  finalizedByUser     Employee?     @relation("Payroll_finalizedByToEmployee", fields: [finalizedBy], references: [id])
}

model Notification {
  id          Int      @id @default(autoincrement())
  userId      Int?
  companyId   Int
  message     String
  type        String
  category    String?
  priority    String   @default("NORMAL")
  redirectUrl String?
  read        Boolean  @default(false)
  createdAt   DateTime @default(now())

  company   Company                @relation(fields: [companyId], references: [id])
  user      Employee?              @relation(fields: [userId], references: [id])
  userReads UserNotificationRead[]

  @@index([companyId, userId])
  @@index([userId, read])
}

model UserNotificationRead {
  id             Int      @id @default(autoincrement())
  userId         Int
  notificationId Int
  readAt         DateTime @default(now())
  hidden         Boolean  @default(false)

  user         Employee     @relation(fields: [userId], references: [id])
  notification Notification @relation(fields: [notificationId], references: [id], onDelete: Cascade)

  @@unique([userId, notificationId])
  @@index([userId])
  @@index([notificationId])
}

model Invitation {
  id           Int              @id @default(autoincrement())
  email        String
  role         Role
  invitedBy    Int
  employeeId   String? // Optional field to link to specific employee
  position     String
  companyId    Int
  departmentId Int
  shiftType    Shift?           @default(MORNING_SHIFT)
  status       InvitationStatus @default(PENDING)
  token        String           @unique
  expiresAt    DateTime
  createdAt    DateTime         @default(now())
  updatedAt    DateTime         @updatedAt
  company      Company          @relation(fields: [companyId], references: [id])
  department   Department       @relation(fields: [departmentId], references: [id])
  inviter      Employee         @relation(fields: [invitedBy], references: [id])
}

model Activity {
  id          Int      @id @default(autoincrement())
  companyId   Int
  type        String
  title       String
  description String
  priority    String   @default("NORMAL")
  icon        String   @default("default")
  createdAt   DateTime @default(now())
  company     Company  @relation(fields: [companyId], references: [id])
}

model EmployeeBenefit {
  id          String          @id
  employeeId  Int
  companyId   Int
  benefitType BenefitCategory
  amount      Float
  isActive    Boolean         @default(true)
  createdAt   DateTime        @default(now())
  updatedAt   DateTime
  Company     Company         @relation(fields: [companyId], references: [id])
  Employee    Employee        @relation(fields: [employeeId], references: [id])
}

model EmployeePayrollProfile {
  id                 String   @id
  employeeId         Int      @unique
  taxBracket         String?
  socialSecurityRate Float    @default(0)
  customTaxRate      Float?   @default(0)
  createdAt          DateTime @default(now())
  updatedAt          DateTime
  Employee           Employee @relation(fields: [employeeId], references: [id])
}

model Document {
  id           Int              @id @default(autoincrement())
  employeeId   Int
  companyId    Int
  fileName     String
  originalName String
  fileUrl      String
  fileSize     Int
  mimeType     String
  category     DocumentCategory @default(OTHER)
  description  String?
  uploadedBy   Int // Who uploaded the document (admin/HR)
  createdAt    DateTime         @default(now())
  updatedAt    DateTime         @updatedAt
  employee     Employee         @relation(fields: [employeeId], references: [id])
  company      Company          @relation(fields: [companyId], references: [id])
  uploader     Employee         @relation("DocumentUploader", fields: [uploadedBy], references: [id])
}

enum Role {
  STAFF
  MANAGER
  ADMIN
  SUPER_ADMIN
}

enum EmployeeStatus {
  ACTIVE
  ON_LEAVE
  INACTIVE
}

enum EmploymentType {
  FULL_TIME
  PART_TIME
  CONTRACTOR
}

enum AttendanceStatus {
  ON_TIME
  ABSENT
  LATE
  EARLY
}

enum LeaveType {
  STUDY
  MATERNITY
  SICK
  VACATION
  ANNUAL
  PERSONAL
}

enum LeaveStatus {
  PENDING
  APPROVED
  REJECTED
}

enum PayrollStatus {
  DRAFT
  FINALIZED
  PAID
}

enum NotificationType {
  LEAVE_REQUEST
  REVIEW
}

enum InvitationStatus {
  PENDING
  ACCEPTED
  EXPIRED
}

enum BenefitCategory {
  CAR_ALLOWANCE
  FOOD_ALLOWANCE
  HOUSING_ALLOWANCE
  TRANSPORT_ALLOWANCE
  MEDICAL_ALLOWANCE
  HEALTH_INSURANCE
  RETIREMENT
  OTHER
}

enum Shift {
  MORNING_SHIFT
  EVENING_SHIFT
}

enum DocumentCategory {
  RESUME
  COVER_LETTER
  ID_DOCUMENT
  BIRTH_CERTIFICATE
  PASSPORT
  WORK_PERMIT
  CONTRACT
  PAYSLIP
  PERFORMANCE_REVIEW
  TRAINING_CERTIFICATE
  MEDICAL_CERTIFICATE
  REFERENCE_LETTER
  DEGREE_CERTIFICATE
  OTHER
}

// Subscription Models
model SubscriptionPlan {
  id           String   @id @default(cuid())
  name         String // "Basic", "Pro", "Enterprise"
  price        Float // Monthly price
  maxEmployees Int? // null = unlimited
  features     String[] // ["attendance", "payroll", "reports"]
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())

  subscriptions Subscription[]
}

model Subscription {
  id           String             @id @default(cuid())
  companyId    Int                @unique
  planId       String
  status       SubscriptionStatus @default(TRIAL)
  trialEndDate DateTime? // When free trial expires (14 days from signup)
  startDate    DateTime?
  endDate      DateTime?
  createdAt    DateTime           @default(now())

  company  Company          @relation(fields: [companyId], references: [id])
  plan     SubscriptionPlan @relation(fields: [planId], references: [id])
  payments Payment[]
}

model Payment {
  id                String        @id @default(cuid())
  companyId         Int
  subscriptionId    String
  amount            Float
  status            PaymentStatus @default(PENDING)
  modemPayReference String?
  paidAt            DateTime?
  createdAt         DateTime      @default(now())

  company      Company      @relation(fields: [companyId], references: [id])
  subscription Subscription @relation(fields: [subscriptionId], references: [id])
}

enum SubscriptionStatus {
  TRIAL // Free trial period (14 days)
  PENDING // Waiting for payment
  ACTIVE // Paid and active
  EXPIRED // Subscription expired
  CANCELLED // User cancelled subscription
}

enum PaymentStatus {
  PENDING
  COMPLETED
  FAILED
}

model WorkdayDaysConfig {
  id        String  @id @default(cuid())
  companyId Int
  monday    Boolean @default(true)
  tuesday   Boolean @default(true)
  wednesday Boolean @default(true)
  thursday  Boolean @default(true)
  friday    Boolean @default(true)
  saturday  Boolean @default(false)
  sunday    Boolean @default(false)
  company   Company @relation(fields: [companyId], references: [id])
}

model EmployeeWorkDaysConfig {
  id         String   @id @default(cuid())
  employeeId Int      @unique
  monday     Boolean  @default(true)
  tuesday    Boolean  @default(true)
  wednesday  Boolean  @default(true)
  thursday   Boolean  @default(true)
  friday     Boolean  @default(true)
  saturday   Boolean  @default(false)
  sunday     Boolean  @default(false)
  employee   Employee @relation(fields: [employeeId], references: [id])
}

// ============================================
// PERFORMANCE MODULE
// ============================================

model PerformanceSettings {
  id                       String      @id @default(uuid())
  companyId                Int         @unique
  defaultRatingScale       RatingScale @default(FIVE_POINT)
  allowSelfReview          Boolean     @default(true)
  requireManagerReview     Boolean     @default(true)
  enableEmailNotifications Boolean     @default(true)
  reminderDaysBefore       Int         @default(7)

  company   Company  @relation(fields: [companyId], references: [id])
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model ReviewTemplate {
  id          String      @id @default(uuid())
  companyId   Int
  name        String
  description String?
  isDefault   Boolean     @default(false)
  ratingScale RatingScale @default(FIVE_POINT)
  isActive    Boolean     @default(true)

  company      Company         @relation(fields: [companyId], references: [id])
  sections     ReviewSection[]
  reviewCycles ReviewCycle[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([companyId])
}

model ReviewSection {
  id          String  @id @default(uuid())
  templateId  String
  title       String
  description String?
  order       Int
  isRequired  Boolean @default(true)

  template  ReviewTemplate   @relation(fields: [templateId], references: [id], onDelete: Cascade)
  questions ReviewQuestion[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([templateId, order])
  @@index([templateId])
}

model ReviewQuestion {
  id           String       @id @default(uuid())
  sectionId    String
  questionText String
  helpText     String?
  order        Int
  questionType QuestionType @default(TEXT_LONG)
  isRequired   Boolean      @default(true)
  options      String[]

  section ReviewSection @relation(fields: [sectionId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([sectionId, order])
  @@index([sectionId])
}

model ReviewCycle {
  id                   String      @id @default(uuid())
  companyId            Int
  templateId           String?
  name                 String
  description          String?
  startDate            DateTime
  endDate              DateTime
  selfReviewDueDate    DateTime?
  managerReviewDueDate DateTime?
  status               CycleStatus @default(DRAFT)

  company  Company         @relation(fields: [companyId], references: [id])
  template ReviewTemplate? @relation(fields: [templateId], references: [id])
  reviews  Review[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([companyId])
  @@index([status])
}

model Review {
  id        String @id @default(uuid())
  cycleId   String
  subjectId Int
  managerId Int?

  status                   PerformanceReviewStatus @default(NOT_STARTED)
  selfReviewCompletedAt    DateTime?
  managerReviewCompletedAt DateTime?
  finalizedAt              DateTime?
  acknowledgedAt           DateTime?

  overallRating      Float?
  overallRatingLabel String?
  managerComments    String?
  employeeComments   String?
  employeeRating     Float?
  hrRating           Float?
  hrRatingLabel      String?
  hrComments         String?
  averageRating      Float?
  averageRatingLabel String?

  cycle     ReviewCycle      @relation(fields: [cycleId], references: [id], onDelete: Cascade)
  subject   Employee         @relation("ReviewSubject", fields: [subjectId], references: [id])
  manager   Employee?        @relation("ReviewManager", fields: [managerId], references: [id])
  responses ReviewResponse[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([cycleId, subjectId])
  @@index([cycleId])
  @@index([subjectId])
  @@index([managerId])
}

model ReviewResponse {
  id           String                @id @default(uuid())
  reviewId     String
  questionId   String
  authorId     Int
  responseType PerformanceReviewType

  textResponse    String?
  ratingValue     Float?
  selectedOptions String[]

  review Review   @relation(fields: [reviewId], references: [id], onDelete: Cascade)
  author Employee @relation(fields: [authorId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([reviewId, questionId, authorId, responseType])
  @@index([reviewId])
  @@index([authorId])
}

// ============================================
// PERFORMANCE ENUMS
// ============================================

enum RatingScale {
  THREE_POINT
  FIVE_POINT
  TEN_POINT
}

enum PerformanceReviewType {
  SELF
  MANAGER
}

enum CycleStatus {
  DRAFT
  ACTIVE
  COMPLETED
  ARCHIVED
}

enum PerformanceReviewStatus {
  NOT_STARTED
  IN_PROGRESS
  PENDING_MANAGER
  COMPLETED
  FINALIZED
  ACKNOWLEDGED
}

enum QuestionType {
  TEXT_SHORT
  TEXT_LONG
  RATING
  MULTIPLE_CHOICE
  YES_NO
}
